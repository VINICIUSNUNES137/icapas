<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordem de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-aberto { background-color: #e0f2fe; color: #0c4a6e; }
        .status-em-orcamento { background-color: #fef9c3; color: #854d0e; }
        .status-aguardando-aprovacao { background-color: #ffedd5; color: #9a3412; }
        .status-aprovado { background-color: #dcfce7; color: #166534; }
        .status-em-execucao { background-color: #dbeafe; color: #1e40af; }
        .status-finalizado { background-color: #e5e7eb; color: #1f2937; }
        .status-entregue { background-color: #d1fae5; color: #065f46; }
        .status-cancelado { background-color: #fee2e2; color: #991b1b; }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #9ca3af;
            border: 2px solid white;
        }
         .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: -16px;
            top: 50%;
            width: 2px;
            height: 100%;
            background-color: #e5e7eb;
        }
        .nav-link.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Tela de Autenticação -->
    <div id="authView" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <!-- Login Form -->
            <form id="loginForm">
                <div class="text-center">
                    <i class="fas fa-tools text-4xl text-indigo-600"></i>
                    <h2 class="mt-4 text-2xl font-bold text-gray-900">Acessar Sistema de O.S.</h2>
                </div>
                <div id="authError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                <div class="mt-6 space-y-4">
                    <input type="email" id="loginEmail" placeholder="Seu e-mail" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="loginPassword" placeholder="Sua senha" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Entrar</button>
                </div>
                <p class="mt-4 text-sm text-center text-gray-600">
                    Não tem uma conta? <a href="#" id="showRegister" class="font-medium text-indigo-600 hover:text-indigo-500">Cadastre-se</a>
                </p>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="hidden">
                 <div class="text-center">
                    <i class="fas fa-user-plus text-4xl text-indigo-600"></i>
                    <h2 class="mt-4 text-2xl font-bold text-gray-900">Criar Nova Conta</h2>
                </div>
                <div id="registerError" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                <div class="mt-6 space-y-4">
                    <input type="email" id="registerEmail" placeholder="Seu e-mail" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="password" id="registerPassword" placeholder="Crie uma senha" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mt-6">
                    <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cadastrar</button>
                </div>
                 <p class="mt-4 text-sm text-center text-gray-600">
                    Já tem uma conta? <a href="#" id="showLogin" class="font-medium text-indigo-600 hover:text-indigo-500">Faça o login</a>
                </p>
            </form>
        </div>
    </div>


    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md flex flex-wrap items-center justify-center sm:justify-between px-4 py-2 sm:py-0 sm:h-16 z-10">
            <div class="flex items-center justify-between w-full sm:w-auto">
                 <div class="flex items-center space-x-3">
                    <i class="fas fa-tools text-2xl text-indigo-600"></i>
                    <h1 class="text-xl font-bold text-gray-800">Sistema de O.S.</h1>
                </div>
            </div>
            <nav class="flex space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                <a href="#" id="navClientes" class="nav-link active px-2 py-1 sm:py-4 font-semibold text-sm">CLIENTES</a>
                <a href="#" id="navOS" class="nav-link text-gray-500 hover:text-indigo-600 px-2 py-1 sm:py-4 font-semibold text-sm">O.S.</a>
                <a href="#" id="navCaixa" class="nav-link text-gray-500 hover:text-indigo-600 px-2 py-1 sm:py-4 font-semibold text-sm">CAIXA</a>
            </nav>
            <div id="auth-status" class="hidden sm:flex items-center space-x-4 text-sm text-gray-500">
                <span id="userEmail" class="font-medium"></span>
                <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-xs font-bold">SAIR</button>
            </div>
        </header>

        <div id="appContainer">
            <!-- Visualização de Clientes -->
            <div id="clientesView" class="flex flex-col md:flex-row">
                <aside id="clientListContainer" class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col">
                    <div class="p-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-700">Clientes</h2>
                            <button id="addClientBtn" class="bg-indigo-600 text-white px-3 py-1.5 rounded-md hover:bg-indigo-700 text-sm font-medium shadow-sm transition-colors">
                                <i class="fas fa-plus mr-2"></i>Novo
                            </button>
                        </div>
                        <div class="mt-4">
                            <input type="text" id="clientSearchInput" placeholder="Pesquisar por nome ou telefone..." class="p-2 border rounded-md w-full">
                        </div>
                    </div>
                    <div id="clientList" class="flex-grow overflow-y-auto p-2 space-y-2">
                         <div class="text-center p-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-4xl mb-2"></i>
                            <p>Carregando clientes...</p>
                         </div>
                    </div>
                </aside>
                <main id="clientDetailsContainer" class="w-full md:w-2/3 flex-grow overflow-y-auto p-2 sm:p-6 hidden md:block">
                    <div id="mainContent">
                        <div class="text-center p-16 text-gray-500 bg-white rounded-lg shadow hidden md:block">
                            <i class="fas fa-mouse-pointer text-5xl mb-4 text-gray-400"></i>
                            <h2 class="text-2xl font-semibold mb-2">Bem-vindo!</h2>
                            <p>Selecione um cliente na lista à esquerda para ver os detalhes ou adicione um novo cliente para começar.</p>
                        </div>
                    </div>
                </main>
            </div>
            
            <!-- Visualização de Ordens de Serviço -->
            <div id="osView" class="hidden p-2 sm:p-6">
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">Ordens de Serviço</h2>
                        <button id="addOsFromOsViewBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-medium shadow-sm">
                            <i class="fas fa-plus mr-2"></i>Nova O.S.
                        </button>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center md:space-x-4 mt-4 flex-wrap">
                        <input type="text" id="osSearchInput" placeholder="Pesquisar por cliente, equipamento ou O.S. #" class="p-2 border rounded-md w-full md:w-1/3">
                        <div id="osStatusFilters" class="flex items-center space-x-1 mt-3 md:mt-0 flex-wrap">
                             <!-- Botões de filtro gerados via JS -->
                        </div>
                    </div>
                </div>
                <div id="allOsList" class="overflow-y-auto space-y-3">
                    <!-- Lista de todas as OS será renderizada aqui -->
                </div>
            </div>

            <!-- Visualização do Caixa -->
            <div id="caixaView" class="hidden p-2 sm:p-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 id="caixaIndicatorTitle" class="text-xs sm:text-sm font-semibold text-gray-500">ENTRADAS DE HOJE</h3>
                        <p id="caixaTotalDia" class="text-xl sm:text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">MANUAIS</h3>
                        <p id="caixaTotalManual" class="text-xl sm:text-2xl font-bold text-blue-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">VIA O.S.</h3>
                        <p id="caixaTotalOS" class="text-xl sm:text-2xl font-bold text-purple-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">TRANSAÇÕES</h3>
                        <p id="caixaTotalTransacoes" class="text-xl sm:text-2xl font-bold text-gray-700">0</p>
                    </div>
                </div>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">DINHEIRO</h3>
                        <p id="caixaTotalDinheiro" class="text-xl sm:text-2xl font-bold text-gray-700">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">PIX</h3>
                        <p id="caixaTotalPix" class="text-xl sm:text-2xl font-bold text-gray-700">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">DÉBITO</h3>
                        <p id="caixaTotalDebito" class="text-xl sm:text-2xl font-bold text-gray-700">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow text-center">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-500">CRÉDITO</h3>
                        <p id="caixaTotalCredito" class="text-xl sm:text-2xl font-bold text-gray-700">R$ 0,00</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow">
                     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 id="caixaTransactionTitle" class="text-lg sm:text-xl font-semibold text-gray-800">Transações de Hoje</h2>
                        <div class="flex items-center space-x-2">
                            <label for="caixaDateFilter" class="text-sm font-medium">Data:</label>
                            <input type="date" id="caixaDateFilter" class="p-1 border rounded-md text-sm">
                        </div>
                        <button id="addManualEntryBtn" class="bg-cyan-600 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-md hover:bg-cyan-700 font-medium shadow-sm text-sm">
                            <i class="fas fa-plus mr-2"></i>Nova Entrada
                        </button>
                    </div>
                    <div id="caixaTransactionsList" class="overflow-y-auto space-y-2">
                        <!-- Lista de transações do caixa será renderizada aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div id="clientModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-lg transform transition-all scale-95 opacity-0" id="clientModalContent">
            <h2 id="clientModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Novo Cliente</h2>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input class="p-2 border rounded-md" type="text" id="clientName" placeholder="Nome Completo" required>
                    <input class="p-2 border rounded-md" type="text" id="clientCpf" placeholder="CPF/CNPJ">
                    <input class="p-2 border rounded-md" type="text" id="clientPhone" placeholder="Telefone" required>
                    <input class="p-2 border rounded-md" type="email" id="clientEmail" placeholder="E-mail">
                </div>
                <div class="mt-4">
                    <input class="p-2 border rounded-md w-full" type="text" id="clientAddress" placeholder="Endereço">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <input class="p-2 border rounded-md" type="text" id="clientCity" placeholder="Cidade">
                    <input class="p-2 border rounded-md" type="text" id="clientState" placeholder="Estado (UF)">
                    <input class="p-2 border rounded-md" type="text" id="clientCep" placeholder="CEP">
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancelClientBtn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="osModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0" id="osModalContent">
            <h2 id="osModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Nova Ordem de Serviço</h2>
            <form id="osForm">
                <input type="hidden" id="osId">
                 <div class="mb-4">
                    <label for="osClientSelector" class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                    <select id="osClientSelector" class="p-2 border rounded-md w-full bg-gray-50" required>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input class="p-2 border rounded-md" type="text" id="osEquipMarca" placeholder="Marca do Equipamento" required>
                    <input class="p-2 border rounded-md" type="text" id="osEquipModelo" placeholder="Modelo do Equipamento" required>
                </div>
                <div class="mt-4">
                    <textarea class="p-2 border rounded-md w-full" id="osDefeito" placeholder="Defeito Relatado" rows="3" required></textarea>
                </div>
                <div class="mt-4">
                    <textarea class="p-2 border rounded-md w-full" id="osObservacoes" placeholder="Observações" rows="2"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                     <div>
                        <label for="osValor" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                        <input class="p-2 border rounded-md w-full" type="number" step="0.01" id="osValor" placeholder="0.00">
                     </div>
                     <div>
                        <label for="osFormaPagamento" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                        <select id="osFormaPagamento" class="p-2 border rounded-md w-full bg-gray-50" required>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Débito">Débito</option>
                            <option value="Crédito">Crédito</option>
                        </select>
                     </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancelOsBtn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="caixaModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 sm:p-8 w-full max-w-md transform transition-all scale-95 opacity-0" id="caixaModalContent">
            <h2 id="caixaModalTitle" class="text-2xl font-bold text-gray-800 mb-6">Nova Entrada no Caixa</h2>
            <form id="caixaForm">
                <input type="hidden" id="caixaEntryId">
                <div class="space-y-4">
                     <input class="p-2 border rounded-md w-full" type="text" id="caixaDescricao" placeholder="Descrição (ex: Venda de capinha)" required>
                     <input class="p-2 border rounded-md w-full" type="number" step="0.01" id="caixaValor" placeholder="Valor (R$)" required>
                     <select id="caixaCategoria" class="p-2 border rounded-md w-full bg-gray-50" required>
                        <option value="Venda de Acessório">Venda de Acessório</option>
                        <option value="Serviço Avulso">Serviço Avulso</option>
                        <option value="Outros">Outros</option>
                     </select>
                     <select id="caixaFormaPagamento" class="p-2 border rounded-md w-full bg-gray-50" required>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="PIX">PIX</option>
                        <option value="Débito">Débito</option>
                        <option value="Crédito">Crédito</option>
                     </select>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancelCaixaBtn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium">Cancelar</button>
                    <button type="submit" id="saveCaixaBtn" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 font-medium">Salvar Entrada</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, 
            query, where, serverTimestamp, orderBy, writeBatch, getDocs, Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
          const firebaseConfig = {
            apiKey: "AIzaSyD7AJ5m60VyCrMBNQ9GraGfQTi3x_90sz0",
            authDomain: "loja-ricardo-4aede.firebaseapp.com",
            projectId: "loja-ricardo-4aede",
            storageBucket: "loja-ricardo-4aede.firebasestorage.app",
            messagingSenderId: "112311650375",
            appId: "1:112311650375:web:937aafd614247fbecbc962"
        };
        
        const effectiveConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(effectiveConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let selectedClientId = null;
        let selectedOSId = null;
        
        let clientMap = new Map();
        let allOs = [];
        let dailyTransactions = [];
        let currentOsFilter = 'Todos';

        // Listeners de coleções (serão ativados após o login)
        let unsubscribeClients = () => {};
        let unsubscribeOS = () => {};
        let unsubscribeCaixa = () => {};

        const getClientesCollection = () => {
            if (!currentUserId) throw new Error("Usuário não autenticado.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/clientes`);
        };

        const getOsCollection = () => {
            if (!currentUserId) throw new Error("Usuário não autenticado.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/ordens_servico`);
        };
        
        const getOsHistoryCollection = (osId) => {
            if (!currentUserId) throw new Error("Usuário não autenticado.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/ordens_servico/${osId}/historico_status`);
        };
        
        const getCaixaCollection = () => {
             if (!currentUserId) throw new Error("Usuário não autenticado.");
            return collection(db, `artifacts/${appId}/users/${currentUserId}/caixa`);
        }


        const STATUS_OPTIONS = {
            'Aberto': 'status-aberto', 'Em Orçamento': 'status-em-orcamento', 'Aguardando Aprovação': 'status-aguardando-aprovacao',
            'Aprovado': 'status-aprovado', 'Em Execução': 'status-em-execucao', 'Finalizado': 'status-finalizado',
            'Entregue': 'status-entregue', 'Cancelado': 'status-cancelado'
        };

        // --- AUTENTICAÇÃO E CARREGAMENTO INICIAL ---
        const mainApp = document.getElementById('mainApp');
        const authView = document.getElementById('authView');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userEmail').innerText = user.email;
                authView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                loadInitialData();
            } else {
                currentUserId = null;
                mainApp.classList.add('hidden');
                authView.classList.remove('hidden');
                // Desconectar listeners
                unsubscribeClients();
                unsubscribeOS();
                unsubscribeCaixa();
            }
        });

        const loadInitialData = () => {
            // Desconectar listeners antigos para evitar duplicação
            unsubscribeClients();
            unsubscribeOS();
            unsubscribeCaixa();

            // Carrega todos os clientes
            unsubscribeClients = onSnapshot(query(getClientesCollection(), orderBy('nome')), (snapshot) => {
                clientMap.clear();
                snapshot.docs.forEach(doc => clientMap.set(doc.id, doc.data()));
                renderClientList();
                renderOsView();
            });

            // Carrega todas as OS
            unsubscribeOS = onSnapshot(query(getOsCollection()), (snapshot) => {
                let osList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                osList.sort((a, b) => {
                    const dateA = a.dataEntrada?.seconds || 0;
                    const dateB = b.dataEntrada?.seconds || 0;
                    return dateB - dateA;
                });
                allOs = osList;
                renderOsView();
            });

            renderStatusFilters();
            listenToCaixaTransactions();
        };
        
        // --- LÓGICA DE NAVEGAÇÃO E RESPONSIVIDADE ---
        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('#appContainer > div');
        const clientListContainer = document.getElementById('clientListContainer');
        const clientDetailsContainer = document.getElementById('clientDetailsContainer');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const clickedLink = e.currentTarget;
                const viewName = clickedLink.id.replace('nav', '');
                const targetViewId = viewName.charAt(0).toLowerCase() + viewName.slice(1) + 'View';
                
                navLinks.forEach(nav => nav.classList.remove('active'));
                clickedLink.classList.add('active');

                views.forEach(view => {
                    view.classList.toggle('hidden', view.id !== targetViewId);
                });

                if (targetViewId === 'clientesView' && window.innerWidth < 768) {
                    showListView();
                } else {
                    if (targetViewId === 'osView') renderOsView();
                    if (targetViewId === 'caixaView') listenToCaixaTransactions();
                }
            });
        });

        const showDetailsView = () => {
            if (window.innerWidth < 768) { 
                clientListContainer.classList.add('hidden');
                clientDetailsContainer.classList.remove('hidden');
            }
        };

        const showListView = () => {
            if (window.innerWidth < 768) {
                clientDetailsContainer.classList.add('hidden');
                clientListContainer.classList.remove('hidden');
                selectedClientId = null;
                renderClientList();
            }
        };

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                clientListContainer.classList.remove('hidden');
                clientDetailsContainer.classList.remove('hidden');
            } else {
                if (document.getElementById('clientesView').classList.contains('hidden')) return;

                if (selectedClientId) {
                    showDetailsView();
                } else {
                    showListView();
                }
            }
            setAppContainerHeight();
        });
        
        const header = document.querySelector('header');
        const appContainer = document.getElementById('appContainer');

        const setAppContainerHeight = () => {
            const headerHeight = header.offsetHeight;
            const containerHeight = `calc(100vh - ${headerHeight}px)`;
            
            views.forEach(view => view.style.height = containerHeight);
            
            document.getElementById('allOsList').style.height = `calc(100vh - ${headerHeight}px - 7.5rem)`;
            document.getElementById('caixaTransactionsList').style.height = `calc(100vh - ${headerHeight}px - 18rem)`; // Adjusted for new indicators
        };

        // --- MODAL HELPERS ---
        const clientModal = document.getElementById('clientModal');
        const clientModalContent = document.getElementById('clientModalContent');
        const osModal = document.getElementById('osModal');
        const osModalContent = document.getElementById('osModalContent');
        const caixaModal = document.getElementById('caixaModal');
        const caixaModalContent = document.getElementById('caixaModalContent');

        function openModal(modal, content) {
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 50);
        }

        function closeModal(modal, content) {
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // --- RENDERIZAÇÃO ---
        const clientListDiv = document.getElementById('clientList');
        const mainContentDiv = document.getElementById('mainContent');

        const renderClientList = () => {
            const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
            const allClients = Array.from(clientMap.entries()).map(([id, data]) => ({ id, ...data }));

            const filteredClients = allClients.filter(client => {
                const nameMatch = client.nome ? client.nome.toLowerCase().includes(searchTerm) : false;
                const phoneMatch = client.telefone ? client.telefone.toLowerCase().includes(searchTerm) : false;
                return nameMatch || phoneMatch;
            });
            
            renderClients(filteredClients);
        };

        const renderClients = (clients) => {
            const searchTerm = document.getElementById('clientSearchInput')?.value || '';
            if (clients.length === 0) {
                 if (searchTerm) {
                    clientListDiv.innerHTML = `<div class="text-center p-8 text-gray-500"><i class="fas fa-search text-4xl mb-2"></i><p>Nenhum cliente encontrado.</p></div>`;
                } else {
                    clientListDiv.innerHTML = `<div class="text-center p-8 text-gray-500"><i class="fas fa-users text-4xl mb-2"></i><p>Nenhum cliente cadastrado.</p></div>`;
                }
                return;
            }
            clientListDiv.innerHTML = clients.map(client => `
                <div class="client-item border rounded-lg p-3 cursor-pointer hover:bg-indigo-50 hover:border-indigo-300 transition-colors ${selectedClientId === client.id ? 'bg-indigo-100 border-indigo-400' : 'bg-white border-gray-200'}" data-id="${client.id}">
                    <h3 class="font-semibold text-gray-800">${client.nome}</h3>
                    <p class="text-sm text-gray-500">${client.telefone}</p>
                </div>
            `).join('');
        };
        
        const renderClientDetails = async (clientId) => {
             const client = clientMap.get(clientId);
             if (!client) return;
             mainContentDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow p-4 sm:p-6">
                    <div class="flex justify-between items-start">
                        <div>
                             <button id="backToListBtn" class="md:hidden mb-4 bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm font-medium">
                                <i class="fas fa-arrow-left mr-2"></i> Voltar para Lista
                            </button>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">${client.nome}</h2>
                            <p class="text-sm text-gray-500">${client.email || ''}</p><p class="text-sm text-gray-500">${client.telefone}</p>
                            <p class="text-sm text-gray-500">${client.endereco || ''}, ${client.cidade || ''} - ${client.estado || ''}</p>
                        </div>
                        <div class="flex space-x-2">
                             <button class="editClientBtn bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-300 text-sm font-medium" data-id="${clientId}"><i class="fas fa-edit"></i></button>
                             <button class="deleteClientBtn bg-red-100 text-red-700 px-3 py-1.5 rounded-md hover:bg-red-200 text-sm font-medium" data-id="${clientId}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-700">Ordens de Serviço</h3>
                            <button class="addOsBtn bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 text-sm font-medium" data-client-id="${clientId}"><i class="fas fa-plus mr-2"></i>Nova O.S.</button>
                        </div>
                        <div id="osList" class="space-y-3"><!-- OS List --></div>
                    </div>
                </div>`;
            document.getElementById('backToListBtn')?.addEventListener('click', showListView);
            loadOSForClient(clientId);
        };

        const renderOSList = (osList, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (osList.length === 0) {
                container.innerHTML = `<div class="text-center py-6 text-gray-500 bg-gray-50 rounded-md"><i class="fas fa-file-alt text-3xl mb-2"></i><p>Nenhuma O.S. encontrada.</p></div>`;
                return;
            }
            container.innerHTML = osList.map(os => {
                const client = clientMap.get(os.clienteId);
                const osIdDisplay = os.id ? os.id.substring(0, 6).toUpperCase() : 'Inválido';
                return `
                <div class="os-item border p-4 rounded-lg cursor-pointer hover:border-indigo-400 transition-colors ${selectedOSId === os.id ? 'bg-indigo-50 border-indigo-400' : 'bg-white'}" data-id="${os.id}">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800">O.S. #${osIdDisplay}</p>
                        <span class="status-badge ${STATUS_OPTIONS[os.statusAtual]}">${os.statusAtual}</span>
                    </div>
                    ${client ? `<p class="text-sm font-semibold text-indigo-700 mt-1">${client.nome}</p>` : ''}
                    <p class="text-sm text-gray-600">${os.equipamentoMarca || ''} ${os.equipamentoModelo || ''}</p>
                    <p class="text-xs text-gray-400 mt-2">Entrada: ${os.dataEntrada ? new Date(os.dataEntrada.seconds * 1000).toLocaleString('pt-BR') : 'N/A'}</p>
                </div>
            `}).join('');
        };
        
        const renderOSDetails = (os, container) => {
             const existingDetails = container.querySelector(`[id^=os-details-]`);
             if (existingDetails) existingDetails.remove();
             if (!os || !os.id) return;

             const osDetailsDiv = document.createElement('div');
             osDetailsDiv.id = `os-details-${os.id}`;
             osDetailsDiv.className = 'mt-4 ml-4 pl-4 border-l-2 border-indigo-200';
             
             const statusOptionsHtml = Object.keys(STATUS_OPTIONS).map(status => `<option value="${status}" ${os.statusAtual === status ? 'selected' : ''}>${status}</option>`).join('');
             const osIdDisplay = os.id ? os.id.substring(0, 6).toUpperCase() : 'Inválido';
             osDetailsDiv.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <p class="font-bold text-lg mb-2">Detalhes da O.S. #${osIdDisplay}</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                        <div><strong class="font-medium text-gray-600">Defeito:</strong> ${os.defeitoRelatado || 'N/A'}</div>
                        <div><strong class="font-medium text-gray-600">Observações:</strong> ${os.observacoes || 'N/A'}</div>
                        <div><strong class="font-medium text-gray-600">Valor Total:</strong> R$ ${parseFloat(os.valorTotal || 0).toFixed(2)}</div>
                        <div><strong class="font-medium text-gray-600">Pagamento:</strong> ${os.formaPagamento || 'N/A'}</div>
                     </div>

                     <div class="mt-4 border-t pt-4">
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center sm:space-x-2">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Alterar Status</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <select id="status-selector-${os.id}" class="p-2 border rounded-md w-full max-w-xs">${statusOptionsHtml}</select>
                                    <button class="changeStatusBtn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" data-id="${os.id}">Salvar</button>
                                </div>
                            </div>
                            <div class="mt-4 sm:mt-0">
                                <label class="block text-sm font-medium text-gray-700">Ações</label>
                                <div class="flex items-center space-x-2 mt-1">
                                    <button class="generatePdfBtn bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full" data-id="${os.id}"><i class="fas fa-file-pdf mr-2"></i>PDF</button>
                                </div>
                            </div>
                        </div>
                     </div>

                     <div class="mt-6">
                        <h4 class="font-semibold mb-3 text-gray-700">Histórico de Status</h4>
                        <div class="relative border-l-2 border-gray-200 ml-5" id="os-history">Carregando...</div>
                     </div>
                </div>`;
            
            container.querySelector(`.os-item[data-id="${os.id}"]`).insertAdjacentElement('afterend', osDetailsDiv);
            
            const historyContainer = osDetailsDiv.querySelector('#os-history');
            onSnapshot(query(getOsHistoryCollection(os.id), orderBy('dataMudanca', 'desc')), (snapshot) => {
                if (snapshot.empty) {
                    historyContainer.innerHTML = '<p class="text-sm text-gray-500">Nenhum histórico.</p>';
                } else {
                    historyContainer.innerHTML = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return `<div class="relative pl-6 pb-4 timeline-item">
                           <p class="text-sm font-semibold text-gray-700">${data.statusNovo}</p>
                           <p class="text-xs text-gray-500">${data.dataMudanca ? new Date(data.dataMudanca.seconds * 1000).toLocaleString('pt-BR') : ''}</p>
                           ${data.statusAnterior ? `<p class="text-xs text-gray-400">De: ${data.statusAnterior}</p>` : ''}
                        </div>`;
                    }).join('');
                }
            });
        };

        // --- OS View Specific Rendering ---
        const renderStatusFilters = () => {
            const filtersContainer = document.getElementById('osStatusFilters');
            const statuses = ['Todos', ...Object.keys(STATUS_OPTIONS)];
            filtersContainer.innerHTML = statuses.map(status => `
                <button class="os-filter-btn px-3 py-1 rounded-full text-xs font-semibold transition-colors ${currentOsFilter === status ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}" data-status="${status}">
                    ${status}
                </button>
            `).join('');
        };
        
        const renderOsView = () => {
            if (osView.classList.contains('hidden')) return;
            const searchTerm = document.getElementById('osSearchInput').value.toLowerCase();
            
            let filteredOs = allOs.filter(os => {
                if (!os || !os.id) return false; 

                const client = clientMap.get(os.clienteId);
                const clientName = client ? client.nome.toLowerCase() : '';
                const equipment = `${os.equipamentoMarca || ''} ${os.equipamentoModelo || ''}`.toLowerCase();
                const osId = os.id.toLowerCase();

                const matchesSearch = clientName.includes(searchTerm) || 
                                      equipment.includes(searchTerm) || 
                                      osId.includes(searchTerm);
                
                const matchesFilter = currentOsFilter === 'Todos' || os.statusAtual === currentOsFilter;
                
                return matchesSearch && matchesFilter;
            });
            renderOSList(filteredOs, 'allOsList');
        };

        // --- LÓGICA DO FIRESTORE ---
        const getClient = (id) => clientMap.get(id) ? {id, ...clientMap.get(id)} : null;
        
        const saveClient = async (clientData) => {
            if (clientData.id) {
                await updateDoc(doc(getClientesCollection(), clientData.id), clientData);
            } else {
                await addDoc(getClientesCollection(), clientData);
            }
        };
        
        const deleteClient = async (id) => {
            const batch = writeBatch(db);
            const osQuery = query(getOsCollection(), where('clienteId', '==', id));
            const osSnapshot = await getDocs(osQuery);
            osSnapshot.forEach(osDoc => batch.delete(osDoc.ref));
            batch.delete(doc(getClientesCollection(), id));
            await batch.commit();
            mainContentDiv.innerHTML = `<div class="text-center p-16 text-gray-500 bg-white rounded-lg shadow"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h2>Cliente Removido</h2></div>`;
        };
        
        const loadOSForClient = (clientId) => {
            const q = query(getOsCollection(), where('clienteId', '==', clientId));
            onSnapshot(q, snapshot => {
                let osList = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                // Ordena a lista em JavaScript para evitar a necessidade de um índice composto
                osList.sort((a, b) => {
                    const dateA = a.dataEntrada ? a.dataEntrada.seconds : 0;
                    const dateB = b.dataEntrada ? b.dataEntrada.seconds : 0;
                    return dateB - dateA; // Ordena do mais recente para o mais antigo
                });
                renderOSList(osList, 'osList');
            }, (error) => {
                console.error("Erro ao carregar O.S. do cliente:", error);
            });
        };
        
        const getOS = async (id) => {
            const osDoc = await getDoc(doc(getOsCollection(), id));
            return osDoc.exists() ? { id: osDoc.id, ...osDoc.data() } : null;
        }

        const saveOS = async (osData, id) => {
             if (id) {
                await updateDoc(doc(getOsCollection(), id), osData);
             } else {
                const batch = writeBatch(db);
                const newOsRef = doc(getOsCollection());
                batch.set(newOsRef, {...osData, statusAtual: 'Aberto', dataEntrada: serverTimestamp()});
                const historyRef = doc(getOsHistoryCollection(newOsRef.id));
                batch.set(historyRef, {statusAnterior: null, statusNovo: 'Aberto', dataMudanca: serverTimestamp(), usuarioResponsavel: auth.currentUser.uid});
                await batch.commit();
             }
        };
        
        const changeOSStatus = async (id, newStatus) => {
            const osRef = doc(getOsCollection(), id);
            const osDoc = await getDoc(osRef);
            if (!osDoc.exists()) return;
            
            const osData = osDoc.data();
            const oldStatus = osData.statusAtual;
            if(oldStatus === newStatus) return;

            const batch = writeBatch(db);
            batch.update(osRef, { statusAtual: newStatus });
            
            const historyRef = doc(getOsHistoryCollection(id));
            batch.set(historyRef, {statusAnterior: oldStatus, statusNovo: newStatus, dataMudanca: serverTimestamp(), usuarioResponsavel: auth.currentUser.uid});
            
            if(newStatus === 'Entregue' && osData.valorTotal > 0) {
                const caixaRef = doc(getCaixaCollection());
                batch.set(caixaRef, {
                    descricao: `Recebimento O.S. #${id.substring(0, 6).toUpperCase()}`,
                    valor: parseFloat(osData.valorTotal),
                    categoria: 'Serviço',
                    tipo: 'os',
                    osId: id,
                    formaPagamento: osData.formaPagamento || 'Não definido',
                    data: serverTimestamp()
                });
            }
            
            await batch.commit();
        };

        const generateOS_PDF = (os, client) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const osIdDisplay = os.id.substring(0, 8).toUpperCase();
            const dataEntrada = os.dataEntrada ? new Date(os.dataEntrada.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';

            // --- STYLING & LAYOUT ---
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const margin = 10;
            const cellPadding = 3;
            let y = 15;

            // --- HELPER FUNCTION FOR BOXES ---
            const drawSectionBox = (startY, height, title) => {
                doc.setDrawColor(209, 213, 219); // coolGray-300
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, startY, pageW - (margin * 2), height, 3, 3, 'FD');
                
                if (title) {
                    doc.setFillColor(243, 244, 246); // coolGray-100
                    doc.roundedRect(margin, startY, pageW - (margin * 2), 10, 3, 3, 'F');
                    doc.line(margin, startY + 10, pageW - margin, startY + 10);
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.setTextColor(31, 41, 55); // coolGray-800
                    doc.text(title, margin + cellPadding, startY + 7);
                }
            };

            // --- HEADER ---
            doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.setTextColor(17, 24, 39);
            doc.text("Ordem de Serviço", pageW / 2, y, { align: 'center' });
            y += 8;
            doc.setFont("helvetica", "normal"); doc.setFontSize(12); doc.setTextColor(107, 114, 128);
            doc.text(`Nº: ${osIdDisplay}`, pageW / 2, y, { align: 'center' });
            y += 12;

            // --- COMPANY & DATE INFO ---
            drawSectionBox(y, 18);
            doc.setFontSize(10); doc.setTextColor(75, 85, 99);
            doc.text("ICapas - CNPJ: 30.735.501/0001-87", margin + cellPadding, y + 7);
            doc.text("R. Américo Vespúcio, 26, Itapevi/SP", margin + cellPadding, y + 12);
            doc.text(`Data de Entrada: ${dataEntrada}`, pageW - margin - cellPadding, y + 7, { align: 'right' });
            y += 23;

            // --- CLIENT & EQUIPMENT INFO ---
            const infoBoxHeight = 28;
            doc.setDrawColor(209, 213, 219);
            doc.roundedRect(margin, y, pageW - (margin * 2), infoBoxHeight, 3, 3, 'S');
            doc.line(pageW / 2, y, pageW / 2, y + infoBoxHeight);

            doc.setFillColor(243, 244, 246);
            doc.roundedRect(margin, y, pageW - (margin * 2), 10, 3, 3, 'F');
            doc.line(margin, y + 10, pageW - margin, y + 10);
            
            doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.setTextColor(31, 41, 55);
            doc.text("Dados do Cliente", margin + cellPadding, y + 7);
            doc.text("Dados do Equipamento", (pageW / 2) + cellPadding, y + 7);

            doc.setFontSize(9); doc.setTextColor(75, 85, 99); doc.setFont("helvetica", "normal");
            doc.text(`Nome: ${client.nome || ''}`, margin + cellPadding, y + 16);
            doc.text(`Telefone: ${client.telefone || ''}`, margin + cellPadding, y + 21);
            
            doc.text(`Tipo: CELULAR`, (pageW / 2) + cellPadding, y + 16);
            doc.text(`Marca: ${os.equipamentoMarca || ''}`, (pageW / 2) + cellPadding, y + 21);
            doc.text(`Modelo: ${os.equipamentoModelo || ''}`, (pageW / 2) + cellPadding, y + 26);
            y += infoBoxHeight + 5;
            
            // --- DESCRIPTION ---
            const sigY = pageH - 45; 
            
            const defeitoLines = doc.splitTextToSize(os.defeitoRelatado || 'Nenhum', pageW - (margin * 2) - (cellPadding * 2));
            const obsLines = doc.splitTextToSize(os.observacoes || 'Nenhuma', pageW - (margin * 2) - (cellPadding * 2));
            const descHeight = 30 + (defeitoLines.length * 5) + (obsLines.length * 5);

            drawSectionBox(y, descHeight, "Descrição do Serviço");
            let descY = y + 16;
            doc.setFont("helvetica", "bold"); doc.text("Defeito Relatado:", margin + cellPadding, descY);
            doc.setFont("helvetica", "normal"); doc.text(defeitoLines, margin + cellPadding, descY + 5);
            descY += 10 + (defeitoLines.length * 5);
            doc.setFont("helvetica", "bold"); doc.text("Observações:", margin + cellPadding, descY);
            doc.setFont("helvetica", "normal"); doc.text(obsLines, margin + cellPadding, descY + 5);
            y += descHeight + 5;

            // --- TOTAL VALUE ---
            doc.setFont("helvetica", "bold"); doc.setFontSize(12);
            doc.text(`Valor Total: R$ ${parseFloat(os.valorTotal || 0).toFixed(2)}`, pageW - margin, y, { align: 'right' });
            
            // --- POLICY ---
            const policyText = [
                "- Garantia de 90 dias para serviços, a partir da data de retirada.",
                "- Telas 'Qualidade Prime': 6 meses de garantia contra defeitos de fabricação (não cobre danos físicos como riscos, arranhados ou trincos).",
                "- Aparelhos com contato com umidade, alto-falantes e troca de vidro não possuem garantia.",
                "- A garantia NÃO COBRE defeitos causados por mau uso (quedas, líquidos, etc.).",
                "- A violação do selo/lacre da empresa anula a garantia do serviço.",
                "- Guarde este comprovante. Ele é sua garantia."
            ];
            const policyStartY = y + 10;
            const policyMaxHeight = sigY - policyStartY - 10;
            drawSectionBox(policyStartY, policyMaxHeight, "Termos de Garantia");
            
            doc.setFontSize(8); doc.setFont("helvetica", "normal"); doc.setTextColor(107, 114, 128);
            doc.text(policyText.join("\n"), margin + cellPadding, policyStartY + 15, { maxWidth: pageW - (margin * 2) - (cellPadding * 2) });
            
            // --- SIGNATURES ---
            doc.line(margin + 10, sigY, (pageW / 2) - 10, sigY);
            doc.setFontSize(10); doc.setTextColor(31, 41, 55);
            doc.text("Assinatura do Cliente", ((pageW/2) - 10 + margin + 10) / 2 , sigY + 5, { align: 'center' });
            doc.line((pageW / 2) + 10, sigY, pageW - margin - 10, sigY);
            doc.text("Assinatura do Técnico", (pageW - margin - 10 + (pageW / 2) + 10) / 2, sigY + 5, { align: 'center' });

            doc.save(`OS-${osIdDisplay}.pdf`);
        };


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setAppContainerHeight();
        });
        
        document.getElementById('addClientBtn').addEventListener('click', () => {
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientModalTitle').innerText = 'Novo Cliente';
            openModal(clientModal, clientModalContent);
        });
        document.getElementById('cancelClientBtn').addEventListener('click', () => closeModal(clientModal, clientModalContent));
        
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('clientId').value;
            const data = { nome: clientName.value, cpf_cnpj: clientCpf.value, telefone: clientPhone.value, email: clientEmail.value, endereco: clientAddress.value, cidade: clientCity.value, estado: clientState.value, cep: clientCep.value };
            if(id) data.id = id;
            await saveClient(data);
            closeModal(clientModal, clientModalContent);
        });
        
        const openOsModalForNew = (selectedClientId = null) => {
            document.getElementById('osForm').reset();
            document.getElementById('osId').value = '';
            const selector = document.getElementById('osClientSelector');
            selector.innerHTML = `<option value="">Selecione um cliente...</option>` +
                Array.from(clientMap.entries()).map(([id, data]) => `<option value="${id}">${data.nome}</option>`).join('');
            
            if (selectedClientId) {
                selector.value = selectedClientId;
                selector.disabled = true;
                document.getElementById('osModalTitle').innerText = `Nova O.S. para ${clientMap.get(selectedClientId).nome}`;
            } else {
                selector.disabled = false;
                document.getElementById('osModalTitle').innerText = 'Nova Ordem de Serviço';
            }
            openModal(osModal, osModalContent);
        };

        document.getElementById('addOsFromOsViewBtn').addEventListener('click', () => openOsModalForNew());
        document.getElementById('cancelOsBtn').addEventListener('click', () => closeModal(osModal, osModalContent));

        document.getElementById('osForm').addEventListener('submit', async (e) => {
             e.preventDefault();
             const id = osId.value || null;
             const data = {
                 clienteId: osClientSelector.value,
                 equipamentoMarca: osEquipMarca.value,
                 equipamentoModelo: osEquipModelo.value,
                 defeitoRelatado: osDefeito.value,
                 observacoes: osObservacoes.value,
                 valorTotal: osValor.value,
                 formaPagamento: osFormaPagamento.value
             };
             await saveOS(data, id);
             closeModal(osModal, osModalContent);
        });

        clientListDiv.addEventListener('click', async (e) => {
            const clientItem = e.target.closest('.client-item');
            if (clientItem) {
                selectedClientId = clientItem.dataset.id;
                renderClientDetails(selectedClientId);
                document.querySelectorAll('.client-item').forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-400'));
                clientItem.classList.add('bg-indigo-100', 'border-indigo-400');
                showDetailsView();
            }
        });
        
        const handleOsItemClick = async (osItem) => {
            const osId = osItem.dataset.id;
            // Toggle selection
            if (selectedOSId === osId) {
                selectedOSId = null;
                const existingDetails = osItem.parentElement.querySelector(`[id^=os-details-]`);
                if (existingDetails) existingDetails.remove();
                osItem.classList.remove('bg-indigo-50', 'border-indigo-400');
            } else {
                selectedOSId = osId;
                const os = await getOS(selectedOSId);
                if (os) {
                    renderOSDetails(os, osItem.parentElement);
                    osItem.parentElement.querySelectorAll('.os-item').forEach(el => el.classList.remove('bg-indigo-50', 'border-indigo-400'));
                    osItem.classList.add('bg-indigo-50', 'border-indigo-400');
                }
            }
        };

        document.getElementById('mainApp').addEventListener('click', async (e) => {
            const osItem = e.target.closest('.os-item');
            if(osItem) handleOsItemClick(osItem);
            
            const addOsBtn = e.target.closest('.addOsBtn');
            if(addOsBtn) openOsModalForNew(addOsBtn.dataset.clientId);
            
            const editClientBtn = e.target.closest('.editClientBtn');
            if (editClientBtn) {
                const client = getClient(editClientBtn.dataset.id);
                document.getElementById('clientForm').reset();
                clientId.value = client.id; clientName.value = client.nome; clientCpf.value = client.cpf_cnpj; clientPhone.value = client.telefone;
                clientEmail.value = client.email; clientAddress.value = client.endereco; clientCity.value = client.cidade;
                clientState.value = client.estado; clientCep.value = client.cep;
                clientModalTitle.innerText = 'Editar Cliente';
                openModal(clientModal, clientModalContent);
            }
            
            const deleteClientBtn = e.target.closest('.deleteClientBtn');
            if (deleteClientBtn) await deleteClient(deleteClientBtn.dataset.id);
            
            const changeStatusBtn = e.target.closest('.changeStatusBtn');
            if (changeStatusBtn) {
                const osId = changeStatusBtn.dataset.id;
                const newStatus = document.getElementById(`status-selector-${osId}`).value;
                await changeOSStatus(osId, newStatus);
            }
            
            const generatePdfBtn = e.target.closest('.generatePdfBtn');
            if (generatePdfBtn) {
                const osId = generatePdfBtn.dataset.id;
                const os = await getOS(osId);
                if (os) {
                    const client = clientMap.get(os.clienteId);
                    if (client) {
                        generateOS_PDF(os, client);
                    } else {
                        alert("Cliente não encontrado para esta OS.");
                    }
                }
            }

            const filterBtn = e.target.closest('.os-filter-btn');
            if (filterBtn) {
                currentOsFilter = filterBtn.dataset.status;
                renderStatusFilters();
                renderOsView();
            }

            const editCaixaBtn = e.target.closest('.edit-caixa-btn');
            if (editCaixaBtn) {
                const entryId = editCaixaBtn.dataset.id;
                const entry = dailyTransactions.find(t => t.id === entryId);
                if (entry) {
                    const form = document.getElementById('caixaForm');
                    form.reset();
                    document.getElementById('caixaEntryId').value = entry.id;
                    document.getElementById('caixaDescricao').value = entry.descricao;
                    document.getElementById('caixaValor').value = entry.valor;
                    document.getElementById('caixaCategoria').value = entry.categoria;
                    document.getElementById('caixaFormaPagamento').value = entry.formaPagamento;
                    
                    document.getElementById('caixaModalTitle').innerText = 'Editar Entrada no Caixa';
                    document.getElementById('saveCaixaBtn').innerText = 'Salvar Alterações';
                    openModal(caixaModal, caixaModalContent);
                }
            }

            const deleteCaixaBtn = e.target.closest('.delete-caixa-btn');
            if (deleteCaixaBtn) {
                const entryId = deleteCaixaBtn.dataset.id;
                // Adicionar confirmação no futuro se necessário
                await deleteDoc(doc(getCaixaCollection(), entryId));
            }

        });
        
        document.getElementById('clientSearchInput').addEventListener('input', renderClientList);
        document.getElementById('osSearchInput').addEventListener('input', renderOsView);

        // --- LÓGICA DO CAIXA ---

        document.getElementById('addManualEntryBtn').addEventListener('click', () => {
            const form = document.getElementById('caixaForm');
            form.reset();
            document.getElementById('caixaEntryId').value = ''; // Limpa o ID
            document.getElementById('caixaModalTitle').innerText = 'Nova Entrada no Caixa';
            document.getElementById('saveCaixaBtn').innerText = 'Salvar Entrada';
            openModal(caixaModal, caixaModalContent);
        });

        document.getElementById('cancelCaixaBtn').addEventListener('click', () => {
            closeModal(caixaModal, caixaModalContent);
        });

        document.getElementById('caixaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('caixaEntryId').value;
            const data = {
                descricao: document.getElementById('caixaDescricao').value,
                valor: parseFloat(document.getElementById('caixaValor').value),
                categoria: document.getElementById('caixaCategoria').value,
                formaPagamento: document.getElementById('caixaFormaPagamento').value,
                tipo: 'manual'
            };

            if (id) {
                // Editando uma entrada existente, não atualiza a data
                await updateDoc(doc(getCaixaCollection(), id), data);
            } else {
                // Nova entrada, adiciona a data
                data.data = serverTimestamp();
                await addDoc(getCaixaCollection(), data);
            }
            closeModal(caixaModal, caixaModalContent);
        });

        const listenToCaixaTransactions = () => {
            unsubscribeCaixa(); // Stop previous listener
            
            const dateInput = document.getElementById('caixaDateFilter');
            if (!dateInput.value) { // Garante que a data esteja definida
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
            }
            
            const [year, month, day] = dateInput.value.split('-').map(Number);
            const selectedDate = new Date(year, month - 1, day);

            selectedDate.setHours(0, 0, 0, 0);
            const nextDay = new Date(selectedDate);
            nextDay.setDate(nextDay.getDate() + 1);

            const today = new Date();
            today.setHours(0,0,0,0);

            const titleElement = document.getElementById('caixaTransactionTitle');
            const indicatorTitleElement = document.getElementById('caixaIndicatorTitle');

            if(selectedDate.getTime() === today.getTime()){
                 titleElement.innerText = "Transações de Hoje";
                 indicatorTitleElement.innerText = "ENTRADAS DE HOJE";
            } else {
                 titleElement.innerText = `Transações de ${selectedDate.toLocaleDateString('pt-BR')}`;
                 indicatorTitleElement.innerText = "ENTRADAS NA DATA";
            }

            const q = query(getCaixaCollection(), where('data', '>=', Timestamp.fromDate(selectedDate)), where('data', '<', Timestamp.fromDate(nextDay)));
            
            unsubscribeCaixa = onSnapshot(q, (snapshot) => {
                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.data.seconds - a.data.seconds);
                updateCaixaIndicators(transactions);
                renderCaixaTransactions(transactions);
            }, (error) => {
                console.error("Erro ao buscar transações do caixa:", error);
                document.getElementById('caixaTransactionsList').innerHTML = `<div class="text-center py-10 text-red-500"><p>Erro ao carregar transações.</p></div>`;
            });
        };

        const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;

        const updateCaixaIndicators = (transactions) => {
            let totalDia = 0, totalManual = 0, totalOS = 0,
                totalDinheiro = 0, totalPix = 0, totalDebito = 0, totalCredito = 0;
            
            transactions.forEach(t => {
                const valor = t.valor || 0;
                totalDia += valor;
                if (t.tipo === 'manual') totalManual += valor;
                if (t.tipo === 'os') totalOS += valor;

                switch(t.formaPagamento) {
                    case 'Dinheiro': totalDinheiro += valor; break;
                    case 'PIX': totalPix += valor; break;
                    case 'Débito': totalDebito += valor; break;
                    case 'Crédito': totalCredito += valor; break;
                }
            });

            document.getElementById('caixaTotalDia').innerText = formatCurrency(totalDia);
            document.getElementById('caixaTotalManual').innerText = formatCurrency(totalManual);
            document.getElementById('caixaTotalOS').innerText = formatCurrency(totalOS);
            document.getElementById('caixaTotalTransacoes').innerText = transactions.length;

            document.getElementById('caixaTotalDinheiro').innerText = formatCurrency(totalDinheiro);
            document.getElementById('caixaTotalPix').innerText = formatCurrency(totalPix);
            document.getElementById('caixaTotalDebito').innerText = formatCurrency(totalDebito);
            document.getElementById('caixaTotalCredito').innerText = formatCurrency(totalCredito);
        };

        const renderCaixaTransactions = (transactions) => {
            const listContainer = document.getElementById('caixaTransactionsList');
            if (transactions.length === 0) {
                listContainer.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fas fa-cash-register text-4xl mb-3"></i><p>Nenhuma transação na data selecionada.</p></div>`;
                return;
            }
            listContainer.innerHTML = transactions.map(t => `
                <div class="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${t.descricao}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <p class="text-xs text-white rounded-full px-2 py-0.5 inline-block ${t.tipo === 'os' ? 'bg-purple-500' : 'bg-blue-500'}">${t.categoria}</p>
                            <p class="text-xs text-gray-500 font-semibold">${t.formaPagamento || ''}</p>
                        </div>
                    </div>
                    <div class="text-right mx-4">
                        <p class="font-bold text-green-600 text-lg">${formatCurrency(t.valor)}</p>
                        <p class="text-xs text-gray-500">${new Date(t.data.seconds * 1000).toLocaleTimeString('pt-BR')}</p>
                    </div>
                    <div class="flex items-center space-x-2 w-20 justify-end">
                        ${t.tipo === 'manual' ? `
                            <button class="edit-caixa-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${t.id}" title="Editar"><i class="fas fa-edit text-blue-500"></i></button>
                            <button class="delete-caixa-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${t.id}" title="Remover"><i class="fas fa-trash text-red-500"></i></button>
                        ` : `
                            <i class="fas fa-receipt text-purple-400 p-2" title="Entrada de O.S."></i>
                        `}
                    </div>
                </div>
            `).join('');
        };

        // --- AUTHENTICATION LOGIC ---
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const authErrorDiv = document.getElementById('authError');
        const registerErrorDiv = document.getElementById('registerError');

        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authErrorDiv.classList.add('hidden');
            } catch (error) {
                authErrorDiv.innerText = "E-mail ou senha inválidos.";
                authErrorDiv.classList.remove('hidden');
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                registerErrorDiv.classList.add('hidden');
            } catch (error) {
                registerErrorDiv.innerText = "Erro ao criar conta. Verifique o e-mail e a senha (mínimo 6 caracteres).";
                registerErrorDiv.classList.remove('hidden');
            }
        });
        
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth);
        });


        // --- RUN ON START ---
        document.addEventListener('DOMContentLoaded', () => {
            setAppContainerHeight();
            document.getElementById('caixaDateFilter').addEventListener('change', listenToCaixaTransactions);
        });

    </script>
</body>
</html>


